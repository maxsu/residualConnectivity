project(residualConnectivity)
cmake_minimum_required(VERSION 3.1)
set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${CMAKE_SOURCE_DIR}/cmake" "${CMAKE_SOURCE_DIR}/..")
set(Boost_USE_STATIC_LIBS	OFF)
set(Boost_USE_MULTITHREADED	ON)
set(Boost_USE_STATIC_RUNTIME	OFF)

if(CMAKE_COMPILER_IS_GNUCC)
	add_definitions("-Wall")
endif()
find_package(Boost 1.53.0 COMPONENTS graph program_options system serialization filesystem regex REQUIRED)
find_package(Qt5 COMPONENTS Widgets Core Gui)
find_package(OpenMP REQUIRED)
find_package(GraphViz)

if(NOT DEFINED EIGEN_INCLUDE_DIR)
	message(FATAL_ERROR "Please point the environment variable EIGEN_INCLUDE_DIR to the include directory of your Eigen3 installation.")
endif()
include_directories("${EIGEN_INCLUDE_DIR}")

if(("${CMAKE_BUILD_TYPE}" STREQUAL "Release") OR ("${CMAKE_BUILD_TYPE}" STREQUAL "RelWithDebInfo"))
	find_package(OpenMP)
endif()

find_package(Mathematica)
find_package(aliasMethod REQUIRED)

if(WIN32)
	find_package(mpfr)
	find_package(mpir)
else()
	#mpfr needs to be listed as an imported target so that we can use target_link_librarie later on. If we don't have this then it just adds a -lmpfr which probably picks up the wrong thing. 
	find_library(mpfr_LIBRARY mpfr)
	add_library(mpfr SHARED IMPORTED)
	set_target_properties(mpfr PROPERTIES IMPORTED_LOCATION ${mpfr_LIBRARY})
endif()
add_subdirectory(residualConnectivityCommon)
add_subdirectory(crudeMC)
add_subdirectory(exhaustiveProbability)
add_subdirectory(exhaustiveSearch)
add_subdirectory(usingBiconnectedSplitting)
add_subdirectory(optimalStateIndependentImportance)
add_subdirectory(transferMatrix)
add_subdirectory(transferMatrixCommon)
add_subdirectory(transferMatrixEstimation)
add_subdirectory(raoBlackwellisation)
add_subdirectory(cancela2002RVR)
add_subdirectory(gridCountSpecificSize)
add_subdirectory(gridCountSpecificSize2)
add_subdirectory(getMinimumReliability)
add_subdirectory(splittingBasic)
add_subdirectory(subObservationVisualiser)
add_subdirectory(articulationConditioningSplitting)
add_subdirectory(articulationConditioningResampling)
add_subdirectory(expectedVertexCount)

set(RESIDUAL_CONNECTIVITY_COMMON_LIBRARY $<TARGET_FILE:residualConnectivityCommon>)
set(RESIDUAL_CONNECTIVITY_CRUDEMC_LIBRARY $<TARGET_FILE:crudeMCLib>)
configure_file(${PROJECT_SOURCE_DIR}/residualConnectivityConfig.cmake.in ${PROJECT_BINARY_DIR}/residualConnectivityConfig.cmake @ONLY)
if(NOT WIN32)
	file(GENERATE OUTPUT ${PROJECT_BINARY_DIR}/residualConnectivityConfig.cmake INPUT ${PROJECT_BINARY_DIR}/residualConnectivityConfig.cmake)
endif()

if(NOT DEFINED ${CMAKE_FIND_LIBRARY_PREFIXES})
	set(CMAKE_FIND_LIBRARY_PREFIXES "")
endif()
find_package(R REQUIRED)

add_custom_target(build_package ALL COMMAND ${R_COMMAND} CMD INSTALL RPackage WORKING_DIRECTORY ${PROJECT_SOURCE_DIR} DEPENDS residualConnectivityCommon)
execute_process(COMMAND "${R_COMMAND} CMD INSTALL RPackage" WORKING_DIRECTORY ${PROJECT_SOURCE_DIR})
